module compile-pseudo

imports 
	signatures/framevm-sig
	signatures/pseudo-sig
	fvm-desugar
	fvm-util
    
rules
  	compile-pseudo: FVM_Program(_, blocks) -> <framevm-from-flat> <concat> [instrs, [FVM_IPush("0"), FVM_Return()]]
      where
	  	_ := <new-counter> "cont";
	  	_ := <new-counter> "then"; 
	  	_ := <new-counter> "else"; 
	  	_ := <new-counter> "fun"; 
      	instrs := <mapconcat(compile-pseudo-instr)> <getfirst(is-pseudo)> blocks
      	
    is-pseudo: FVM_PseudoCode(body) -> body
    
    compile-pseudo-instr: PsdDefine(Bind(name, idx), exp) -> <concat> [exp_instr, set_instr]
      where
      	exp_instr := <compile-pseudo-exp> exp;
	  	cont_lbl := FVM_Label($[CONT_[<next-counter> "cont"]]);
	  	set_instr := []
//      	set_instr := [FVM_New("1"), FVM_Dup(), FVM_Link(FVM_Self(), FVM_Link("P")), FVM_Dup(), FVM_SetR(FVM_Path([FVM_Slot(<int-to-string> idx)])), FVM_ScopeDown(cont_lbl), cont_lbl]
      	
   compile-pseudo-instr: PsdAssign(ref, exp) -> <concat> [exp_instr, set_instr]
      where
      	exp_instr := <compile-pseudo-exp> exp;
      	path := FVM_Path(<compile-ref> ref);
      	set_instr := [FVM_Set(path)]
      	
      
   compile-ref: PsdRef(PsdID(obj), tail) -> <concat> [obj_path, tail_path]
     where
     	FVM_Path(obj_path) := <framevm-path-from-nabl2> (obj, "PsdVar", "index");
     	tail_path := <compile-ref> tail
     	
   compile-ref: PsdID(ref) -> obj_path
     where
     	FVM_Path(obj_path) := <framevm-path-from-nabl2> (ref, "PsdVar", "index")
    	
   compile-pseudo-exp: PsdInt(n) -> [FVM_IPush(n)]
   
   
   