module fvm-interpreter

imports 
	signatures/framevm-sig
	interpreter/-
	fvm-desugar
    
rules
  	eval-program: (FVM_Program(s, blocks), (links, conts)) -> out
      where 
    	env1 := <vm-init> (links, conts, s);
      	env2 := <foldl(store-block)> (blocks, env1);
      	env3 := <store-block> (FVM_Block(FVM_Label("_exit"), FVM_Seq([])), env2);
      	env4 := <store-block> (FVM_Block(FVM_Label("_catch"), FVM_Seq([])), env3);
      	env5 := <vm-start(|env4)>;
    	env6 := <execute(|env5)>;
    	out  := <vm-stop(|env6)>
    	
    store-block: (FVM_PseudoCode(_), env) -> env
  	store-block: (FVM_Block(FVM_Label(lbl), FVM_Seq(body)), env) -> <vm-store-block(|env)> (lbl, body)
    
    // Ask next instruction and evaluate it
    // Repeat until no instructions are left
  	execute(|env) = vm-execute(debug(!"execute: "); eval | env)
//  	execute(|env) = vm-execute(eval | env)

    // Instruction not implemented or execution failed
	// Catches current instructions and reports them
	eval: (instr, env) -> <fail>
	  where
	  	_ := <debug> ("Execution failed at instruction", instr)