module stc_smoke_routineres

language framevm

test Routine resolution example [[#init 2
MAIN:
	stack := 3
	new
	dup
	link [] P
	set [0]
	new 1
	dup
	link [0] P
	dup
	ipush 2
	setr [0]
	
	call FUNC MAIN_CONT
	
MAIN_CONT:
	rget
	set [1]
	get [1]
	print
	ipush 0
	return
	
FUNC:
	stack := 4
	get [0]
	ipush 0
	eqi
	jumpz FUNC_ELSE FUNC_THEN
	
FUNC_THEN:
	stack := 1
	ipush 42
	return
	
FUNC_ELSE:	
	new 1
	dup
	new
	dup
	link [P, P] P
	linkr P
	dup
	get [0]
	ipush -1
	addi
	setr [0]
	call FUNC_THEN FUNC_END
	
FUNC_END:
	rget
	return
]] transform "Run -> Run" to "IntV(42)"
	
	