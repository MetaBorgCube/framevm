module smoke_exception_trace

language framevm

test Exception trace example RISC [[MAIN:
	new
	dup
	link [] P
	cnewr MAIN_TRY
	new
	dup
	link [] P
	cnewr MAIN_CATCH
	try
	
MAIN_TRY:
	new
	dup
	link [P] P
	call FUNC1 MAIN_END
	
FUNC1:
	new
	dup
	link [] P
	call FUNC2 FUNC1_END
	
FUNC1_END:
	get [r]
	return
	
FUNC2:
	new
	dup
	get []
	setr [0]
	dup
	ipush 1
	setr [1]
	throw
	
MAIN_CATCH:
	get [r, 1]
	print
	get [r, 0]
	dup
	set [0]
	dup
	print
	dup
	getr [P]
	print
	getr [P, P]
	print
	scopeup [P] MAIN_END
	
MAIN_END:
	ipush 0
	return
]] transform "Run -> RISC" to "1
frame_4
frame_3
frame_0"

test Exception trace example CISC [[MAIN:
	new
	dup
	link [] P
	cnewr MAIN_TRY
	new
	dup
	link [] P
	cnewr MAIN_CATCH
	try
	
MAIN_TRY:
	new
	dup
	link [P] P
	call FUNC1 MAIN_END
	
FUNC1:
	new
	dup
	link [] P
	call FUNC2 FUNC1_END
	
FUNC1_END:
	get [r]
	return
	
FUNC2:
	new
	dup
	get []
	setr [0]
	dup
	ipush 1
	setr [1]
	throw
	
MAIN_CATCH:
	get [r, 1]
	print
	get [r, 0]
	dup
	set [0]
	dup
	print
	dup
	getr [P]
	print
	getr [P, P]
	print
	scopeup [P] MAIN_END
	
MAIN_END:
	ipush 0
	return
]] transform "Run -> CISC" to "1
frame_4
frame_3
frame_0"