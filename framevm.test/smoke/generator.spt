module smoke_generator

language framevm

test Generator example RISC [[MAIN:
	new
	dup
	link [] P

	newscope FOR_INIT
	
FOR_INIT:
	new 0
	dup
	link [] P

	new 0
	dup
	link [] P

	try FOR_START FOR_TERM FOR_END
	
FOR_START:
	new 0
	dup
	link [] P

	cnew FUNC 2
	dup
	cget [x]
	csetr [x]
	dup
	cthis
	csetr [c]

	jump FOR
	
FOR:
	ccall FOR_RET
	
FOR_RET:
	rget 2
	print
	jump FOR
	
FOR_TERM:
	cret [n]
	
FOR_END:
	jump MAIN_END
	
FUNC:
	cthis
	ipush 1
	cget [c]
	transfer 2
	cget [c]
	ccall FUNC_1
	
FUNC_1:
	ipush 2
	yield FUNC_2
	
FUNC_2:
	ipush 3
	yield FUNC_3
	
FUNC_3:	
	ipush -1
	throw
	
MAIN_END:
	ipush 0
	return
]] transform "Run -> RISC" to "1
2
3"


test Generator example CISC [[MAIN:
	new
	dup
	link [] P

	newscope FOR_INIT
	
FOR_INIT:
	new 0
	dup
	link [] P

	new 0
	dup
	link [] P

	try FOR_START FOR_TERM FOR_END
	
FOR_START:
	new 0
	dup
	link [] P

	cnew FUNC 2
	dup
	cget [x]
	csetr [x]
	dup
	cthis
	csetr [c]

	jump FOR
	
FOR:
	ccall FOR_RET
	
FOR_RET:
	rget 2
	print
	jump FOR
	
FOR_TERM:
	cret [n]
	
FOR_END:
	jump MAIN_END
	
FUNC:
	cthis
	ipush 1
	cget [c]
	transfer 2
	cget [c]
	ccall FUNC_1
	
FUNC_1:
	ipush 2
	yield FUNC_2
	
FUNC_2:
	ipush 3
	yield FUNC_3
	
FUNC_3:	
	ipush -1
	throw
	
MAIN_END:
	ipush 0
	return
]] transform "Run -> CISC" to "1
2
3"

