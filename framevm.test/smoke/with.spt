module smoke_with

language framevm

test with example RISC [[MAIN:
	new 3
	newscope P WITH_I_INIT
	
WITH_I_INIT:
	new 4

	dup
	ipush 4
	setr [0]

	dup
	ipush 5
	setr [1]

	dup
	ipush 6
	setr [2]

	dup
	ipush 7
	setr [3]
	set [1]

	ipush 1
	set [2]
	jump WITH_I
	
WITH_I:
	get [2]
	get [1, 0]
	eqi
	jumpz WITH_I_NEXT WITH_I_END
	
WITH_I_NEXT:
	get [1]
	get [2]
	getr
	set [0]

	new 3
	newscope P WITH_J_INIT
	
WITH_I_INC:	
	get [2]
	ipush 1
	addi
	set [2]
	jump WITH_I
	
WITH_I_END:
	exitscope [P] MAIN_END
	
	
WITH_J_INIT:
	new 4

	dup
	ipush 4
	setr [0]

	dup
	ipush 1
	setr [1]

	dup
	ipush 2
	setr [2]

	dup
	ipush 3
	setr [3]
	set [1]

	ipush 1
	set [2]
	jump WITH_J
	
WITH_J:
	get [2]
	get [1, 0]
	eqi
	jumpz WITH_J_NEXT WITH_J_END
	
WITH_J_NEXT:
	get [1]
	get [2]
	getr
	set [0]

	get [0]
	get [P, 0]
	addi
	ipush 9
	eqi
	jumpz WITH_J_ASSERT_FALSE WITH_J_ASSERT_TRUE
	
WITH_J_ASSERT_TRUE:
	get [P, 0]
	print
	get [0]
	print
	jump WITH_J_ASSERT_FALSE
	
WITH_J_ASSERT_FALSE:
	get [2]
	ipush 1
	addi
	set [2]
	jump WITH_J
	
WITH_J_END:
	exitscope [P] WITH_I_INC
	
MAIN_END:
	ipush 0
	return
]] transform "Run -> RISC" to "6
3
7
2"

test with example CISC [[MAIN:
	new 3
	newscope P WITH_I_INIT
	
WITH_I_INIT:
	new 4

	dup
	ipush 4
	setr [0]

	dup
	ipush 5
	setr [1]

	dup
	ipush 6
	setr [2]

	dup
	ipush 7
	setr [3]
	set [1]

	ipush 1
	set [2]
	jump WITH_I
	
WITH_I:
	get [2]
	get [1, 0]
	eqi
	jumpz WITH_I_NEXT WITH_I_END
	
WITH_I_NEXT:
	get [1]
	get [2]
	getr
	set [0]

	new 3
	newscope P WITH_J_INIT
	
WITH_I_INC:	
	get [2]
	ipush 1
	addi
	set [2]
	jump WITH_I
	
WITH_I_END:
	exitscope [P] MAIN_END
	
	
WITH_J_INIT:
	new 4

	dup
	ipush 4
	setr [0]

	dup
	ipush 1
	setr [1]

	dup
	ipush 2
	setr [2]

	dup
	ipush 3
	setr [3]
	set [1]

	ipush 1
	set [2]
	jump WITH_J
	
WITH_J:
	get [2]
	get [1, 0]
	eqi
	jumpz WITH_J_NEXT WITH_J_END
	
WITH_J_NEXT:
	get [1]
	get [2]
	getr
	set [0]

	get [0]
	get [P, 0]
	addi
	ipush 9
	eqi
	jumpz WITH_J_ASSERT_FALSE WITH_J_ASSERT_TRUE
	
WITH_J_ASSERT_TRUE:
	get [P, 0]
	print
	get [0]
	print
	jump WITH_J_ASSERT_FALSE
	
WITH_J_ASSERT_FALSE:
	get [2]
	ipush 1
	addi
	set [2]
	jump WITH_J
	
WITH_J_END:
	exitscope [P] WITH_I_INC
	
MAIN_END:
	ipush 0
	return
]] transform "Run -> CISC" to "6
3
7
2"
	
	