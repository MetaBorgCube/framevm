module smoke_loops

language framevm

test Loops example [[MAIN:
	new 1
	newscope MAIN2

MAIN2:
	ipush 0
	set [0]
	new 2
	dup
	link [] P
	newscope FOR_INIT
	
FOR_INIT:
	ipush 0
	set [0]
	jump FOR

FOR:
	get[0]
	ipush 3
	lti
	jumpz FOR_END FOR_BODY
	
FOR_BODY:
	get [0]
	set [1]
	
	new
	dup
	link [] P
	newscope WHILE

WHILE:
	get [P, 1]
	ipush 4
	eqi
	jumpz WHILE_BODY WHILE_END 
	
WHILE_BODY:
	get [P, 1]
	dup
	print
	ipush 1
	addi
	set [P, 1]
	get [P, P, 0]
	ipush 1
	addi
	set [P, P, 0]
	jump WHILE
	
WHILE_END:
	exitscope [P] FOR_INC
	
FOR_INC:
	get [0]
	ipush 1
	addi
	set [0]
	jump FOR
	
	
FOR_END:
	exitscope [P] MAIN_END

MAIN_END:
	get[0]
	print
	ipush 0
	return
]] transform "Run -> RISC" to "0
1
2
3
1
2
3
2
3
9"

test Loops example CISC [[MAIN:
	new 1
	newscope MAIN2

MAIN2:
	ipush 0
	set [0]
	new 2
	dup
	link [] P
	newscope FOR_INIT
	
FOR_INIT:
	ipush 0
	set [0]
	jump FOR

FOR:
	get[0]
	ipush 3
	lti
	jumpz FOR_END FOR_BODY
	
FOR_BODY:
	get [0]
	set [1]
	
	new
	dup
	link [] P
	newscope WHILE

WHILE:
	get [P, 1]
	ipush 4
	eqi
	jumpz WHILE_BODY WHILE_END 
	
WHILE_BODY:
	get [P, 1]
	dup
	print
	ipush 1
	addi
	set [P, 1]
	get [P, P, 0]
	ipush 1
	addi
	set [P, P, 0]
	jump WHILE
	
WHILE_END:
	exitscope [P] FOR_INC
	
FOR_INC:
	get [0]
	ipush 1
	addi
	set [0]
	jump FOR
	
	
FOR_END:
	exitscope [P] MAIN_END

MAIN_END:
	get[0]
	print
	ipush 0
	return
]] transform "Run -> CISC" to "0
1
2
3
1
2
3
2
3
9"	
	
	