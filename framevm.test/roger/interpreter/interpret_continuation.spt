module rgr_interpreter_continuations

language framevm

fixture [[MAIN:
	local := 99
	r0 <- cnew(new(), LBL1, 2)
	[[...]]
	
LBL1:
	local := 0
	print(iload(1))
	return(iload(0))
	
MAIN_END:
	print(iload(12))
	return(iload(0))
]]

test return [[
	transfer(iload(0), c)
	cret(cget(c))
]] transform "Run -> Run" to ""

test ccall 1 [[
	cset(r0, c, cgetcurrent())
	ccall(r0, MAIN_END)
]] transform "Run -> Run" to "IntV(1)
IntV(12)"

test tailcall [[
	r1 <- cnew(new(), LBL2, 2)
	cset(r1, c, cget(c))
	ccall(r1, MAIN2)
MAIN2:
	print(iload(42))
	return(iload(0))
LBL2:
	local := 0
	print(iload(2))
	return(iload(0))
]] transform "Run -> Run" to "IntV(2)"

test tailcall 2 [[
	r1 <- cnew(new(), LBL2, 2)
	cset(r1, c, cget(cgetcurrent(), c))
	ccall(r1, MAIN2)
MAIN2:
	print(iload(42))
	return(iload(0))
LBL2:
	local := 0
	print(iload(2))
	return(iload(0))
]] transform "Run -> Run" to "IntV(2)"

test ccall [[
	cset(r0, c, cgetcurrent())
	ccall(r0, MAIN2)
MAIN2:
	r0 <- rget()
	print(r0)
	return(iload(0))
]] transform "Run -> Run" to "IntV(1)
IntV(0)"

test rget single [[
	cset(r0, c, cgetcurrent())
	ccall(r0, MAIN2)
MAIN2:
	r0 <- rget(1)
	print(r0)
	return(iload(0))
]] transform "Run -> Run" to "IntV(1)
IntV(0)"

test rget multiple [[
	r0 <- cnew(new(), LBL, 2)
	cset(r0, c, cgetcurrent())
	ccall(r0, MAIN2)
MAIN2:
	r0, r1 <- rget(2)
	print(r0)
	print(r1)
	return(iload(0))
LBL:
	local := 0
	transfer(iload(1), iload(2), cget(c))
	cret(cget(c))
]] transform "Run -> Run" to "IntV(2)
IntV(1)"

test rget multiple 2 [[
	r0 <- cnew(new(), LBL, 2)
	cset(r0, c, cgetcurrent())
	ccall(r0, MAIN2)
MAIN2:
	r0, r1 <- rget(2)
	print(r0)
	print(r1)
	return(iload(0))
LBL:
	local := 0
	transfer(iload(1), cget(c))
	transfer(iload(2), cget(c))
	cret(cget(c))
]] transform "Run -> Run" to "IntV(2)
IntV(1)"

test variable cont slots [[
	r2 <- iload(3)
	r3 <- new(1)
	set(r3, [0], r2)
	r1 <- cnew(r3, MAIN2, addi(r2, iload(1)))
	cset(r1, r2, cget(c))
	cret(r1)
MAIN2:
	local := 1
	r0 <- get([0])
	print(r0)
	transfer(iload(0), cget(r0))
	cret(cget(r0))
]] transform "Run -> Run" to "IntV(3)"
